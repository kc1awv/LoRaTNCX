let currentTab="lora",autoRefreshEnabled=!0,autoRefreshInterval=null,toastCounter=0,loadedTabs={},lastStatusData=null,pageVisible=!0;function switchTab(e){document.querySelectorAll(".nav-tab").forEach(e=>e.classList.remove("active")),event.target.closest(".nav-tab").classList.add("active"),document.querySelectorAll(".content-section").forEach(e=>e.classList.remove("active")),document.getElementById(e+"-tab").classList.add("active"),currentTab=e,loadedTabs[e]||("lora"===e?(loadBoardInfo(),loadLoRaConfig()):"wifi"===e?loadWiFiConfig():"gnss"===e?(loadGNSSConfig(),loadGNSSStatus()):"system"===e&&loadSystemInfo(),loadedTabs[e]=!0)}function showAlert(e,t,n=currentTab){showToast(e,"success"===e?"Success":"error"===e?"Error":"Warning",t)}function showToast(e,t,n,o=5e3){const s=document.getElementById("toastContainer"),a="toast-"+ ++toastCounter,i=document.createElement("div");return i.className=`toast ${e}`,i.id=a,i.innerHTML=`\n        <div class="toast-content">\n            <div class="toast-icon">\n                <i class="fas fa-${"success"===e?"check-circle":"error"===e?"exclamation-circle":"exclamation-triangle"}"></i>\n            </div>\n            <div class="toast-text">\n                <div class="toast-title">${t}</div>\n                <div class="toast-message">${n}</div>\n            </div>\n            <button class="toast-close" onclick="hideToast('${a}')">\n                <i class="fas fa-times"></i>\n            </button>\n        </div>\n    `,s.appendChild(i),setTimeout(()=>i.classList.add("show"),10),o>0&&setTimeout(()=>hideToast(a),o),a}function hideToast(e){const t=document.getElementById(e);t&&(t.classList.remove("show"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300))}function showConfirmation(e,t,n,o="Confirm",s=!1){const a=document.getElementById("confirmationDialog"),i=document.getElementById("confirmationTitle"),d=document.getElementById("confirmationMessage"),c=document.getElementById("confirmationConfirm");i.textContent=e,d.textContent=t,c.textContent=o,c.className="btn "+(s?"btn-danger":"btn-primary"),c.onclick=()=>{n(),closeConfirmation()},a.classList.add("show")}function closeConfirmation(){document.getElementById("confirmationDialog").classList.remove("show")}function setButtonLoading(e,t){const n=document.getElementById(e);n&&(t?(n.classList.add("loading"),n.disabled=!0):(n.classList.remove("loading"),n.disabled=!1))}function showProgress(e,t){const n=document.getElementById(e);if(n)if(t){n.classList.add("show");const e=n.querySelector(".progress-fill");e.style.width="0%",setTimeout(()=>e.style.width="100%",10)}else n.classList.remove("show")}function validateField(e,t,n){const o=document.getElementById(e),s=o.closest(".form-group"),a=document.getElementById(e+"-validation");return t(o.value)?(s.classList.remove("error"),s.classList.add("success"),a&&(a.textContent=""),!0):(s.classList.remove("success"),s.classList.add("error"),a&&(a.textContent=n),!1)}function clearValidation(e){const t=document.getElementById(e).closest(".form-group"),n=document.getElementById(e+"-validation");t.classList.remove("error","success"),n&&(n.textContent="")}function toggleAutoRefresh(){autoRefreshEnabled=document.getElementById("autoRefresh").checked,autoRefreshEnabled?(startAutoRefresh(),showToast("success","Auto-refresh Enabled","Status will update automatically every 5 seconds")):(stopAutoRefresh(),showToast("warning","Auto-refresh Disabled","Status will not update automatically"))}function startAutoRefresh(){stopAutoRefresh();autoRefreshInterval=setInterval(()=>{autoRefreshEnabled&&pageVisible&&loadStatusOptimized()},pageVisible?5e3:3e4)}function stopAutoRefresh(){autoRefreshInterval&&(clearInterval(autoRefreshInterval),autoRefreshInterval=null)}function toggleKeyboardShortcuts(){document.getElementById("keyboardShortcuts").classList.toggle("show")}function filterNetworks(){const e=document.getElementById("networkSearch").value.toLowerCase();document.querySelectorAll(".network-item").forEach(t=>{t.textContent.toLowerCase().includes(e)?t.style.display="flex":t.style.display="none"})}function refreshCurrentTab(){switch(currentTab){case"lora":loadLoRaConfig();break;case"wifi":loadWiFiConfig();break;case"gnss":loadGNSSConfig(),loadGNSSStatus();break;case"system":loadSystemInfo()}showToast("success","Refreshed",`Reloaded ${currentTab} configuration`)}async function loadStatus(){try{const e=await apiGet("status");e.wifi.connected&&e.wifi.ap_active?(document.getElementById("wifiStatus").textContent="AP + Station",document.getElementById("wifiIcon").className="status-icon online",document.getElementById("ipAddress").textContent="AP: "+e.wifi.ap_ip+" | STA: "+e.wifi.sta_ip):e.wifi.connected?(document.getElementById("wifiStatus").textContent="Connected",document.getElementById("wifiIcon").className="status-icon online",document.getElementById("ipAddress").textContent=e.wifi.sta_ip):e.wifi.ap_active?(document.getElementById("wifiStatus").textContent="AP Mode",document.getElementById("wifiIcon").className="status-icon online",document.getElementById("ipAddress").textContent=e.wifi.ap_ip):(document.getElementById("wifiStatus").textContent="Offline",document.getElementById("wifiIcon").className="status-icon offline",document.getElementById("ipAddress").textContent="-"),document.getElementById("battery").textContent=e.battery.voltage.toFixed(2)+" V";const t=e.system.uptime,n=Math.floor(t/3600),o=Math.floor(t%3600/60);document.getElementById("uptime").textContent=n+"h "+o+"m"}catch(e){console.error("Failed to load status:",e)}}async function loadStatusOptimized(){try{const e=await apiGet("status");if(hasStatusChanged(e)){lastStatusData=e,e.wifi.connected&&e.wifi.ap_active?(document.getElementById("wifiStatus").textContent="AP + Station",document.getElementById("wifiIcon").className="status-icon online",document.getElementById("ipAddress").textContent="AP: "+e.wifi.ap_ip+" | STA: "+e.wifi.sta_ip):e.wifi.connected?(document.getElementById("wifiStatus").textContent="Connected",document.getElementById("wifiIcon").className="status-icon online",document.getElementById("ipAddress").textContent=e.wifi.sta_ip):e.wifi.ap_active?(document.getElementById("wifiStatus").textContent="AP Mode",document.getElementById("wifiIcon").className="status-icon online",document.getElementById("ipAddress").textContent=e.wifi.ap_ip):(document.getElementById("wifiStatus").textContent="Offline",document.getElementById("wifiIcon").className="status-icon offline",document.getElementById("ipAddress").textContent="-"),document.getElementById("battery").textContent=e.battery.voltage.toFixed(2)+" V";const t=e.system.uptime,n=Math.floor(t/3600),o=Math.floor(t%3600/60);document.getElementById("uptime").textContent=n+"h "+o+"m"}}catch(e){console.error("Status update failed:",e)}}function hasStatusChanged(e){return!lastStatusData||(e.wifi.connected!==lastStatusData.wifi.connected||e.wifi.ap_active!==lastStatusData.wifi.ap_active||e.wifi.ap_ip!==lastStatusData.wifi.ap_ip||e.wifi.sta_ip!==lastStatusData.wifi.sta_ip||(Math.abs(e.battery.voltage-lastStatusData.battery.voltage)>.1||e.system.uptime!==lastStatusData.system.uptime))}async function loadBoardInfo(){try{const e=(await apiGet("system")).board.type,t=document.getElementById("power"),n=document.getElementById("power-range");4===e?(t.max=28,n.textContent="Valid range: -9 to 28 dBm (V4 with PA gain control)"):(t.max=22,n.textContent="Valid range: -9 to 22 dBm")}catch(e){console.error("Failed to load board info:",e)}}async function loadLoRaConfig(){try{const e=await apiGet("lora/config");document.getElementById("frequency").value=e.frequency,document.getElementById("bandwidth").value=e.bandwidth,document.getElementById("spreading").value=e.spreading,document.getElementById("codingRate").value=e.codingRate,document.getElementById("power").value=e.power,document.getElementById("syncWord").value="0x"+e.syncWord.toString(16).toUpperCase()}catch(e){showAlert("error","Failed to load LoRa configuration")}}async function applyLoRaConfig(){const e=validateField("frequency",e=>{const t=parseFloat(e);return t>=150&&t<=960},"Frequency must be between 150-960 MHz"),t=validateField("power",e=>{const t=parseInt(e),n=document.getElementById("power").max;return t>=-9&&t<=parseInt(n)},`Power must be between -9 to ${document.getElementById("power").max} dBm`),n=validateField("syncWord",e=>/^0x[0-9A-Fa-f]{4}$/.test(e),"Sync word must be in format 0xXXXX (4 hex digits)");if(e&&t&&n){setButtonLoading("applyLoRaBtn",!0),showProgress("loraProgress",!0);try{const e=parseInt(document.getElementById("syncWord").value,16),t={frequency:parseFloat(document.getElementById("frequency").value),bandwidth:parseFloat(document.getElementById("bandwidth").value),spreading:parseInt(document.getElementById("spreading").value),codingRate:parseInt(document.getElementById("codingRate").value),power:parseInt(document.getElementById("power").value),syncWord:e};await apiPost("lora/config",t),showAlert("success","LoRa configuration applied successfully")}catch(e){showAlert("error","Failed to apply LoRa configuration")}finally{setButtonLoading("applyLoRaBtn",!1),setTimeout(()=>showProgress("loraProgress",!1),1e3)}}else showToast("error","Validation Error","Please correct the highlighted fields")}async function saveLoRaConfig(){setButtonLoading("saveLoRaBtn",!0),showProgress("loraProgress",!0);try{await apiPost("lora/save"),showAlert("success","LoRa configuration saved to flash")}catch(e){showAlert("error","Failed to save LoRa configuration")}finally{setButtonLoading("saveLoRaBtn",!1),setTimeout(()=>showProgress("loraProgress",!1),1e3)}}async function resetLoRaConfig(){showConfirmation("Reset LoRa Configuration","Are you sure you want to reset LoRa configuration to defaults? This will restore factory settings.",async()=>{setButtonLoading("resetLoRaBtn",!0),showProgress("loraProgress",!0);try{await apiPost("lora/reset"),showAlert("success","LoRa configuration reset to defaults"),await loadLoRaConfig(),clearValidation("frequency"),clearValidation("power"),clearValidation("syncWord")}catch(e){showAlert("error","Failed to reset LoRa configuration")}finally{setButtonLoading("resetLoRaBtn",!1),setTimeout(()=>showProgress("loraProgress",!1),1e3)}},"Reset",!0)}async function loadWiFiConfig(){try{const e=await apiGet("wifi/config");document.getElementById("wifiMode").value=e.mode,document.getElementById("apSsid").value=e.ap_ssid,document.getElementById("staSsid").value=e.ssid,document.getElementById("dhcp").checked=e.dhcp,document.getElementById("staticIp").value=e.ip,document.getElementById("gateway").value=e.gateway,document.getElementById("subnet").value=e.subnet,document.getElementById("dns").value=e.dns,document.getElementById("tcpKissEnabled").checked=e.tcp_kiss_enabled,document.getElementById("tcpKissPort").value=e.tcp_kiss_port,updateWiFiModeUI(),updateDHCPUI()}catch(e){showAlert("error","Failed to load WiFi configuration","wifi")}}function updateWiFiModeUI(){const e=parseInt(document.getElementById("wifiMode").value),t=document.getElementById("ap-config"),n=document.getElementById("sta-config");t.style.display=1===e||3===e?"block":"none",n.style.display=2===e||3===e?"block":"none"}function updateDHCPUI(){const e=document.getElementById("dhcp").checked;document.getElementById("static-ip-config").style.display=e?"none":"block"}async function applyWiFiConfig(){setButtonLoading("applyWiFiBtn",!0),showProgress("wifiProgress",!0);try{const e={mode:parseInt(document.getElementById("wifiMode").value),ap_ssid:document.getElementById("apSsid").value,ap_password:document.getElementById("apPassword").value,ssid:document.getElementById("staSsid").value,password:document.getElementById("staPassword").value,dhcp:document.getElementById("dhcp").checked,tcp_kiss_enabled:document.getElementById("tcpKissEnabled").checked,tcp_kiss_port:parseInt(document.getElementById("tcpKissPort").value)},t=parseInt(document.getElementById("wifiMode").value);await apiPost("wifi/config",e),showAlert("success",0===t||2===t?"WiFi configuration applied. Note: Connection may be lost if changing modes. You may need to reconnect to the new network.":"WiFi configuration applied successfully","wifi")}catch(e){showAlert("error","Failed to apply WiFi configuration","wifi")}finally{setButtonLoading("applyWiFiBtn",!1),setTimeout(()=>showProgress("wifiProgress",!1),1e3)}}async function saveWiFiConfig(){try{await apiPost("wifi/save"),showAlert("success","WiFi configuration saved to flash","wifi")}catch(e){showAlert("error","Failed to save WiFi configuration","wifi")}}async function scanWiFi(){try{if("started"!==(await apiGet("wifi/scan")).status)throw new Error("Failed to start scan");document.getElementById("networkListContent").innerHTML='<div class="loading">Starting WiFi scan...</div>',document.getElementById("networkList").style.display="block",document.getElementById("networkSearch").value="";const e=async()=>{try{const t=await apiGet("wifi/scan/status");if("completed"===t.status)displayScanResults(t.networks);else{if("scanning"!==t.status)throw"idle"===t.status?new Error("Scan was cancelled or failed to start"):new Error("Scan failed");document.getElementById("networkListContent").innerHTML=`<div class="loading">Scanning networks... ${t.progress}%</div>`,setTimeout(e,500)}}catch(e){showAlert("error","Failed to check scan status","wifi")}};setTimeout(e,500)}catch(e){showAlert("error","Failed to start WiFi scan","wifi")}}function displayScanResults(e){const t=document.getElementById("networkListContent");t.innerHTML="",e&&e.length>0?(e.forEach(e=>{const n=document.createElement("div");n.className="network-item",n.onclick=()=>{document.getElementById("staSsid").value=e.ssid,showToast("success","Network Selected",`Selected: ${e.ssid}`)};let o="ðŸ“¶";e.rssi>-50?o="ðŸ“¶ðŸ“¶ðŸ“¶":e.rssi>-70&&(o="ðŸ“¶ðŸ“¶"),n.innerHTML=`\n                <div class="network-info">\n                    <div class="signal-strength">${o}</div>\n                    <div class="network-details">\n                        <strong>${e.ssid}</strong><br>\n                        <small>${e.rssi} dBm ${e.encrypted?"ðŸ”’":"ðŸ”“"}</small>\n                    </div>\n                </div>\n            `,t.appendChild(n)}),showToast("success","Scan Complete",`Found ${e.length} networks`)):(t.innerHTML='<div class="loading">No networks found</div>',showToast("warning","No Networks","No WiFi networks were found"))}async function loadGNSSConfig(){try{const e=await apiGet("gnss/config");document.getElementById("gnssEnabled").checked=e.enabled,document.getElementById("gnssSerialPassthrough").checked=e.serialPassthrough||!1,document.getElementById("gnssTcpPort").value=e.tcpPort,document.getElementById("gnssBaudRate").value=e.baudRate,e.hasBuiltInPort?(document.getElementById("gnss-pin-config").style.display="none",document.getElementById("gnss-unavailable").style.display="none"):(document.getElementById("gnss-pin-config").style.display="block",document.getElementById("gnss-unavailable").style.display="block",document.getElementById("gnssPinRX").value=e.pinRX,document.getElementById("gnssPinTX").value=e.pinTX,document.getElementById("gnssPinCtrl").value=e.pinCtrl,document.getElementById("gnssPinWake").value=e.pinWake,document.getElementById("gnssPinPPS").value=e.pinPPS,document.getElementById("gnssPinRST").value=e.pinRST)}catch(e){showAlert("error","Failed to load GNSS configuration","gnss")}}async function loadGNSSStatus(){try{const e=await apiGet("gnss/status");e.running?(document.getElementById("gnss-fix-status").textContent=e.hasFix?"âœ… Fixed":"â³ Searching",document.getElementById("gnss-satellites").textContent=e.satellites||0,document.getElementById("gnss-hdop").textContent=e.hdop?e.hdop.toFixed(1):"-",e.hasFix?(document.getElementById("gnss-lat").textContent=e.latitude?e.latitude.toFixed(6)+"Â°":"-",document.getElementById("gnss-lon").textContent=e.longitude?e.longitude.toFixed(6)+"Â°":"-",document.getElementById("gnss-alt").textContent=e.altitude?e.altitude.toFixed(1)+" m":"-"):(document.getElementById("gnss-lat").textContent="-",document.getElementById("gnss-lon").textContent="-",document.getElementById("gnss-alt").textContent="-")):(document.getElementById("gnss-fix-status").textContent="â­• Disabled",document.getElementById("gnss-satellites").textContent="-",document.getElementById("gnss-hdop").textContent="-",document.getElementById("gnss-lat").textContent="-",document.getElementById("gnss-lon").textContent="-",document.getElementById("gnss-alt").textContent="-"),e.nmeaServer?(document.getElementById("gnss-nmea-status").textContent=e.nmeaServer.running?"âœ… Running":"â­• Stopped",document.getElementById("gnss-nmea-port").textContent=e.nmeaServer.port,document.getElementById("gnss-nmea-clients").textContent=e.nmeaServer.clients):(document.getElementById("gnss-nmea-status").textContent="-",document.getElementById("gnss-nmea-port").textContent="-",document.getElementById("gnss-nmea-clients").textContent="-")}catch(e){console.error("Failed to load GNSS status:",e)}}async function applyGNSSConfig(){try{const e={enabled:document.getElementById("gnssEnabled").checked,serialPassthrough:document.getElementById("gnssSerialPassthrough").checked,tcpPort:parseInt(document.getElementById("gnssTcpPort").value),baudRate:parseInt(document.getElementById("gnssBaudRate").value)};"none"!==document.getElementById("gnss-pin-config").style.display&&(e.pinRX=parseInt(document.getElementById("gnssPinRX").value),e.pinTX=parseInt(document.getElementById("gnssPinTX").value),e.pinCtrl=parseInt(document.getElementById("gnssPinCtrl").value),e.pinWake=parseInt(document.getElementById("gnssPinWake").value),e.pinPPS=parseInt(document.getElementById("gnssPinPPS").value),e.pinRST=parseInt(document.getElementById("gnssPinRST").value));(await apiPost("gnss/config",e)).rebootRequired?showAlert("success","GNSS configuration applied. Reboot required for TCP port or baud rate changes.","gnss"):showAlert("success","GNSS configuration applied successfully","gnss"),setTimeout(loadGNSSStatus,1e3)}catch(e){showAlert("error","Failed to apply GNSS configuration","gnss")}}async function saveGNSSConfig(){await applyGNSSConfig()}async function loadSystemInfo(){try{const e=await apiGet("system"),t=await apiGet("lora/config");document.getElementById("sys-board-name").textContent=e.board.name,document.getElementById("sys-board-type").textContent="V"+e.board.type,document.getElementById("sys-chip-model").textContent=e.chip.model,document.getElementById("sys-chip-revision").textContent=e.chip.revision,document.getElementById("sys-chip-cores").textContent=e.chip.cores,document.getElementById("sys-chip-freq").textContent=e.chip.frequency+" MHz",document.getElementById("sys-flash-size").textContent=(e.memory.flash_size/1024/1024).toFixed(0)+" MB",document.getElementById("sys-free-heap").textContent=(e.memory.free_heap/1024).toFixed(1)+" KB",document.getElementById("sys-heap-size").textContent=(e.memory.heap_size/1024).toFixed(1)+" KB",document.getElementById("sys-lora-freq").textContent=t.frequency+" MHz",document.getElementById("sys-lora-bw").textContent=t.bandwidth+" kHz",document.getElementById("sys-lora-sf").textContent="SF"+t.spreading,document.getElementById("sys-lora-pwr").textContent=t.power+" dBm"}catch(e){console.error("Failed to load system info:",e)}}async function rebootDevice(){showConfirmation("Reboot Device","Are you sure you want to reboot the device? This will temporarily disconnect all connections.",async()=>{setButtonLoading("rebootBtn",!0),showProgress("systemProgress",!0);try{await apiPost("reboot"),showToast("warning","Rebooting","Device is rebooting. Please wait 10 seconds and refresh the page.",0)}catch(e){showAlert("error","Failed to reboot device"),setButtonLoading("rebootBtn",!1),showProgress("systemProgress",!1)}},"Reboot",!0)}async function init(){const e=document.getElementById("loadingOverlay");e.classList.remove("hidden");const[t,n,o]=await Promise.all([loadStatus(),apiGet("system"),loadLoRaConfig()]);document.getElementById("boardName").textContent=n.board.name,startAutoRefresh(),setInterval(()=>{autoRefreshEnabled&&loadStatus()},5e3),setInterval(()=>{"gnss"===currentTab&&loadGNSSStatus()},3e3),setTimeout(()=>{e.classList.add("hidden"),showToast("success","Welcome","LoRaTNCX Control Center loaded successfully")},1e3)}async function apiGet(e){const t=await fetch(`/api/${e}`);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return await t.json()}async function apiPost(e,t=null){const n={method:"POST",headers:{"Content-Type":"application/json"}};null!==t&&(n.body=JSON.stringify(t));const o=await fetch(`/api/${e}`,n);if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);const s=o.headers.get("content-type");return s&&s.includes("application/json")?await o.json():{success:!0}}document.addEventListener("DOMContentLoaded",function(){tippy(".tooltip-trigger",{theme:"light",placement:"top",arrow:!0,delay:[300,0]}),loadBoardInfo(),loadLoRaConfig(),loadedTabs.lora=!0,document.addEventListener("visibilitychange",function(){pageVisible=!document.hidden,pageVisible&&autoRefreshEnabled?startAutoRefresh():pageVisible||stopAutoRefresh()})}),document.addEventListener("keydown",function(e){if("INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&"SELECT"!==e.target.tagName)switch(e.key.toLowerCase()){case"1":e.preventDefault(),switchTab("lora");break;case"2":e.preventDefault(),switchTab("wifi");break;case"3":e.preventDefault(),switchTab("gnss");break;case"4":e.preventDefault(),switchTab("system");break;case"r":e.preventDefault(),refreshCurrentTab();break;case"a":e.preventDefault();const t=document.getElementById("autoRefresh");t.checked=!t.checked,toggleAutoRefresh();break;case"?":e.preventDefault(),toggleKeyboardShortcuts()}}),window.addEventListener("load",init);