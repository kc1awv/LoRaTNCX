<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoRaTNCX Control Center</title>
    <link href="font-awesome.min.css" rel="stylesheet">
    <link href="tippy-light-theme.css" rel="stylesheet">
    <script src="popper.min.js"></script>
    <script src="tippy-bundle.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-bg: #0a0a0a;
            --secondary-bg: #1a1a1a;
            --card-bg: #2a2a2a;
            --accent: #00d4aa;
            --accent-hover: #00f5c4;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border: #404040;
            --success: #00d4aa;
            --warning: #ffb347;
            --error: #ff6b6b;
            --shadow: rgba(0, 212, 170, 0.1);
            --loading-bg: rgba(0, 212, 170, 0.1);
            --loading-border: rgba(0, 212, 170, 0.3);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header with Status */
        .header {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px var(--shadow);
        }

        .header h1 {
            color: var(--accent);
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1 i {
            color: var(--accent);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .status-card {
            background: var(--secondary-bg);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .status-icon.online {
            background: var(--success);
            color: #000;
        }

        .status-icon.offline {
            background: var(--error);
            color: #000;
        }

        .status-icon.neutral {
            background: var(--accent);
            color: #000;
        }

        .status-content h3 {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .status-content .value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Navigation */
        .nav-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 0;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .nav-tabs {
            display: flex;
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--border);
        }

        .nav-tab {
            flex: 1;
            padding: 20px 24px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 500;
            position: relative;
        }

        .nav-tab:hover {
            background: rgba(0, 212, 170, 0.1);
            color: var(--accent);
        }

        .nav-tab.active {
            background: var(--accent);
            color: #000;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent);
        }

        /* Content Areas */
        .content-section {
            display: none;
            background: var(--card-bg);
            border-radius: 16px;
            padding: 32px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px var(--shadow);
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .section-header i {
            color: var(--accent);
            font-size: 24px;
        }

        .section-header h2 {
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 600;
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group label i {
            color: var(--accent);
            width: 16px;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="password"],
        .form-group select {
            background: var(--secondary-bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
        }

        .form-group .help-text {
            color: var(--text-secondary);
            font-size: 12px;
            margin-top: 4px;
        }

        /* Checkboxes */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--secondary-bg);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--accent);
        }

        .checkbox-group label {
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 32px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: var(--accent);
            color: #000;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 212, 170, 0.3);
        }

        .btn-secondary {
            background: var(--secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-danger {
            background: var(--error);
            color: #000;
        }

        .btn-danger:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }

        /* Cards and Info Display */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .info-card {
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .info-card h4 {
            color: var(--accent);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-card h4 i {
            color: var(--accent);
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-item .label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .info-item .value {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
        }

        /* Network Scanning */
        .network-scanner {
            margin-top: 16px;
        }

        .network-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .network-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .network-item:hover {
            background: rgba(0, 212, 170, 0.1);
        }

        .network-item:last-child {
            border-bottom: none;
        }

        .network-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .signal-strength {
            font-size: 18px;
        }

        .network-details strong {
            color: var(--text-primary);
            display: block;
        }

        .network-details small {
            color: var(--text-secondary);
        }

        /* Alerts */
        .alert {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: rgba(0, 212, 170, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .alert-error {
            background: rgba(255, 107, 107, 0.1);
            color: var(--error);
            border: 1px solid var(--error);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        /* Enhanced UX Styles */
        .btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-group {
            position: relative;
        }

        .form-group.error input,
        .form-group.error select {
            border-color: var(--error);
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        .form-group.success input,
        .form-group.success select {
            border-color: var(--success);
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
        }

        .form-group .validation-message {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            font-size: 12px;
            padding: 4px 8px;
            margin-top: 2px;
            border-radius: 4px;
            display: none;
            z-index: 10;
        }

        .form-group.error .validation-message {
            display: block;
            background: rgba(255, 107, 107, 0.1);
            color: var(--error);
            border: 1px solid var(--error);
        }

        .form-group.success .validation-message {
            display: block;
            background: rgba(0, 212, 170, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .tooltip-trigger {
            cursor: help;
            margin-left: 4px;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .tooltip-trigger:hover {
            opacity: 1;
        }

        .auto-refresh-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--secondary-bg);
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .auto-refresh-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--accent);
        }

        .auto-refresh-toggle label {
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--secondary-bg);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
            display: none;
        }

        .progress-bar.show {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s ease;
        }

        .network-search {
            margin-bottom: 16px;
        }

        .network-search input {
            width: 100%;
            padding: 12px 16px;
            background: var(--secondary-bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .network-search input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .keyboard-shortcuts {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 16px var(--shadow);
            display: none;
            z-index: 1000;
            max-width: 300px;
        }

        .keyboard-shortcuts.show {
            display: block;
        }

        .keyboard-shortcuts h4 {
            color: var(--accent);
            margin-bottom: 12px;
            font-size: 14px;
        }

        .keyboard-shortcuts .shortcut {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .keyboard-shortcuts .key {
            background: var(--secondary-bg);
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid var(--border);
            color: var(--accent);
            font-weight: bold;
        }

        .floating-action-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            color: #000;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 16px var(--shadow);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .floating-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .confirmation-dialog.show {
            opacity: 1;
            visibility: visible;
        }

        .confirmation-content {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px var(--shadow);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .confirmation-dialog.show .confirmation-content {
            transform: scale(1);
        }

        .confirmation-content h3 {
            color: var(--text-primary);
            margin-bottom: 16px;
            font-size: 18px;
        }

        .confirmation-content p {
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .confirmation-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
            pointer-events: none;
        }

        .toast {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: 0 4px 16px var(--shadow);
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: auto;
            max-width: 350px;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--error);
        }

        .toast.warning {
            border-left: 4px solid var(--warning);
        }

        .toast-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .toast-icon {
            flex-shrink: 0;
            margin-top: 2px;
        }

        .toast-text {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            margin-left: 12px;
            flex-shrink: 0;
        }

        .toast-close:hover {
            color: var(--text-primary);
        }

        /* Enhanced mobile experience */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .floating-action-btn {
                bottom: 16px;
                left: 16px;
            }

            .keyboard-shortcuts {
                bottom: 16px;
                right: 16px;
                left: 16px;
                max-width: none;
            }

            .confirmation-content {
                margin: 20px;
                width: calc(100% - 40px);
            }

            .toast-container {
                left: 16px;
                right: 16px;
                top: 16px;
            }
        }

        /* Pulse animation for status updates */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .status-updating {
            animation: pulse 0.5s ease-in-out;
        }

        /* Smooth transitions for tab switching */
        .content-section {
            animation: fadeIn 0.3s ease-out;
        }

        /* Better focus states for accessibility */
        .btn:focus,
        input:focus,
        select:focus,
        .checkbox-group input:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Loading Screen */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
        }

        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
        }

        .loading-content {
            text-align: center;
            color: var(--text-primary);
        }

        .loading-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .loading-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-content">
            <div class="loading-title">LoRaTNCX</div>
            <div class="loading-subtitle">Initializing Control Center...</div>
        </div>
    </div>

    <div class="container">
        <!-- Header with Status -->
        <div class="header">
            <h1><i class="fas fa-satellite"></i> LoRaTNCX Control Center</h1>
            <div class="status-grid" id="statusGrid">
                <div class="status-card">
                    <div class="status-icon neutral" id="boardIcon"><i class="fas fa-microchip"></i></div>
                    <div class="status-content">
                        <h3>Board</h3>
                        <div class="value" id="boardName">Loading...</div>
                    </div>
                </div>
                <div class="status-card">
                    <div class="status-icon offline" id="wifiIcon"><i class="fas fa-wifi"></i></div>
                    <div class="status-content">
                        <h3>WiFi Status</h3>
                        <div class="value" id="wifiStatus">Checking...</div>
                    </div>
                </div>
                <div class="status-card">
                    <div class="status-icon neutral" id="ipIcon"><i class="fas fa-network-wired"></i></div>
                    <div class="status-content">
                        <h3>IP Address</h3>
                        <div class="value" id="ipAddress">-</div>
                    </div>
                </div>
                <div class="status-card">
                    <div class="status-icon neutral" id="batteryIcon"><i class="fas fa-battery-half"></i></div>
                    <div class="status-content">
                        <h3>Battery</h3>
                        <div class="value" id="battery">-</div>
                    </div>
                </div>
                <div class="status-card">
                    <div class="status-icon neutral" id="uptimeIcon"><i class="fas fa-clock"></i></div>
                    <div class="status-content">
                        <h3>Uptime</h3>
                        <div class="value" id="uptime">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-container">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('lora')">
                    <i class="fas fa-broadcast-tower"></i> LoRa Radio
                </button>
                <button class="nav-tab" onclick="switchTab('wifi')">
                    <i class="fas fa-wifi"></i> Network
                </button>
                <button class="nav-tab" onclick="switchTab('gnss')">
                    <i class="fas fa-satellite"></i> GNSS
                </button>
                <button class="nav-tab" onclick="switchTab('system')">
                    <i class="fas fa-cogs"></i> System
                </button>
            </div>
        </div>

        <!-- Auto-refresh Toggle -->
        <div class="auto-refresh-toggle">
            <input type="checkbox" id="autoRefresh" checked onchange="toggleAutoRefresh()">
            <label for="autoRefresh">Auto-refresh status every 5 seconds</label>
        </div>

        <!-- LoRa Configuration Tab -->
        <div class="content-section active" id="lora-tab">
            <div class="section-header">
                <i class="fas fa-broadcast-tower"></i>
                <h2>LoRa Radio Configuration</h2>
            </div>

            <div class="alert alert-success" id="lora-alert-success"></div>
            <div class="alert alert-error" id="lora-alert-error"></div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="frequency"><i class="fas fa-wave-square"></i> Frequency (MHz)
                        <i class="fas fa-info-circle tooltip-trigger" data-tippy-content="Operating frequency for LoRa communication. Must match your region's regulations."></i>
                    </label>
                    <input type="number" id="frequency" step="0.1" min="150" max="960">
                    <div class="help-text">Valid range: 150-960 MHz</div>
                    <div class="validation-message" id="frequency-validation"></div>
                </div>

                <div class="form-group">
                    <label for="bandwidth"><i class="fas fa-arrows-alt-h"></i> Bandwidth (kHz)
                        <i class="fas fa-info-circle tooltip-trigger" data-tippy-content="Signal bandwidth. Lower values = longer range but slower data rate."></i>
                    </label>
                    <select id="bandwidth">
                        <option value="125">125 kHz</option>
                        <option value="250">250 kHz</option>
                        <option value="500">500 kHz</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="spreading"><i class="fas fa-chart-line"></i> Spreading Factor
                        <i class="fas fa-info-circle tooltip-trigger" data-tippy-content="Higher values = longer range but slower speed. SF7-SF12 available."></i>
                    </label>
                    <select id="spreading">
                        <option value="7">SF7 (Fastest)</option>
                        <option value="8">SF8</option>
                        <option value="9">SF9</option>
                        <option value="10">SF10</option>
                        <option value="11">SF11</option>
                        <option value="12">SF12 (Longest Range)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="codingRate"><i class="fas fa-shield-alt"></i> Coding Rate
                        <i class="fas fa-info-circle tooltip-trigger" data-tippy-content="Error correction strength. Higher values = better reliability but slower speed."></i>
                    </label>
                    <select id="codingRate">
                        <option value="5">4/5 (Fast)</option>
                        <option value="6">4/6</option>
                        <option value="7">4/7</option>
                        <option value="8">4/8 (Robust)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="power"><i class="fas fa-bolt"></i> TX Power (dBm)
                        <i class="fas fa-info-circle tooltip-trigger" data-tippy-content="Transmission power. Higher values = longer range but more power consumption."></i>
                    </label>
                    <input type="number" id="power" min="-9" max="22">
                    <div class="help-text">Valid range: -9 to 22 dBm</div>
                    <div class="validation-message" id="power-validation"></div>
                </div>

                <div class="form-group">
                    <label for="syncWord"><i class="fas fa-key"></i> Sync Word (Hex)
                        <i class="fas fa-info-circle tooltip-trigger" data-tippy-content="Network identifier. Devices must use the same sync word to communicate."></i>
                    </label>
                    <input type="text" id="syncWord" placeholder="0x1424">
                    <div class="help-text">2-byte hex value (e.g., 0x1424)</div>
                    <div class="validation-message" id="syncWord-validation"></div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="applyLoRaConfig()" id="applyLoRaBtn">
                    <i class="fas fa-play"></i> Apply Configuration
                </button>
                <button class="btn btn-primary" onclick="saveLoRaConfig()" id="saveLoRaBtn">
                    <i class="fas fa-save"></i> Save to Flash
                </button>
                <button class="btn btn-secondary" onclick="loadLoRaConfig()" id="loadLoRaBtn">
                    <i class="fas fa-sync"></i> Reload
                </button>
                <button class="btn btn-danger" onclick="resetLoRaConfig()" id="resetLoRaBtn">
                    <i class="fas fa-undo"></i> Reset to Defaults
                </button>
            </div>
            <div class="progress-bar" id="loraProgress">
                <div class="progress-fill"></div>
            </div>
        </div>

        <!-- WiFi Configuration Tab -->
        <div class="content-section" id="wifi-tab">
            <div class="section-header">
                <i class="fas fa-wifi"></i>
                <h2>Network Configuration</h2>
            </div>

            <div class="alert alert-success" id="wifi-alert-success"></div>
            <div class="alert alert-error" id="wifi-alert-error"></div>

            <div class="form-group">
                <label for="wifiMode"><i class="fas fa-toggle-on"></i> WiFi Mode</label>
                <select id="wifiMode" onchange="updateWiFiModeUI()">
                    <option value="0">Off</option>
                    <option value="1">Access Point Only</option>
                    <option value="2">Station Only (Client)</option>
                    <option value="3">AP + Station</option>
                </select>
            </div>

            <div id="ap-config" style="display: none;">
                <h3 style="color: var(--accent); margin: 24px 0 16px 0;"><i class="fas fa-router"></i> Access Point Settings</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="apSsid"><i class="fas fa-wifi"></i> AP Network Name</label>
                        <input type="text" id="apSsid" maxlength="31">
                    </div>

                    <div class="form-group">
                        <label for="apPassword"><i class="fas fa-lock"></i> AP Password</label>
                        <input type="password" id="apPassword" maxlength="63">
                        <div class="help-text">Leave empty for open network (not recommended)</div>
                    </div>
                </div>
            </div>

            <div id="sta-config" style="display: none;">
                <h3 style="color: var(--accent); margin: 24px 0 16px 0;"><i class="fas fa-house-signal"></i> Station Settings</h3>

                <div class="form-group">
                    <label for="staSsid"><i class="fas fa-search"></i> Network Name (SSID)</label>
                    <div style="display: flex; gap: 12px;">
                        <input type="text" id="staSsid" maxlength="31" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="scanWiFi()" style="flex-shrink: 0;">
                            <i class="fas fa-search"></i> Scan
                        </button>
                    </div>
                </div>

                <div id="networkList" class="network-scanner" style="display: none;">
                    <div class="network-search">
                        <input type="text" id="networkSearch" placeholder="Search networks..." onkeyup="filterNetworks()">
                    </div>
                    <div class="network-list" id="networkListContent">
                        <!-- Networks will be populated here -->
                    </div>
                </div>

                <div class="form-group">
                    <label for="staPassword"><i class="fas fa-key"></i> Network Password</label>
                    <input type="password" id="staPassword" maxlength="63">
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="dhcp" checked onchange="updateDHCPUI()">
                    <label for="dhcp">Use DHCP (Automatic IP)</label>
                </div>

                <div id="static-ip-config" style="display: none;">
                    <h4 style="color: var(--accent); margin: 24px 0 16px 0;"><i class="fas fa-network-wired"></i> Static IP Configuration</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="staticIp"><i class="fas fa-map-marker-alt"></i> IP Address</label>
                            <input type="text" id="staticIp" placeholder="192.168.1.100">
                        </div>

                        <div class="form-group">
                            <label for="gateway"><i class="fas fa-route"></i> Gateway</label>
                            <input type="text" id="gateway" placeholder="192.168.1.1">
                        </div>

                        <div class="form-group">
                            <label for="subnet"><i class="fas fa-mask"></i> Subnet Mask</label>
                            <input type="text" id="subnet" placeholder="255.255.255.0">
                        </div>

                        <div class="form-group">
                            <label for="dns"><i class="fas fa-server"></i> DNS Server</label>
                            <input type="text" id="dns" placeholder="8.8.8.8">
                        </div>
                    </div>
                </div>
            </div>

            <h3 style="color: var(--accent); margin: 32px 0 16px 0;"><i class="fas fa-plug"></i> TCP KISS Server</h3>
            <div class="checkbox-group">
                <input type="checkbox" id="tcpKissEnabled" checked>
                <label for="tcpKissEnabled">Enable TCP KISS Server</label>
                <div class="help-text" style="margin-left: 32px;">Allow network clients to connect to the TNC via TCP/IP</div>
            </div>

            <div class="form-group" style="margin-top: 16px;">
                <label for="tcpKissPort"><i class="fas fa-portrait"></i> TCP KISS Port</label>
                <input type="number" id="tcpKissPort" min="1" max="65535" value="8001">
                <div class="help-text">Default: 8001</div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="applyWiFiConfig()" id="applyWiFiBtn">
                    <i class="fas fa-play"></i> Apply Configuration
                </button>
                <button class="btn btn-primary" onclick="saveWiFiConfig()" id="saveWiFiBtn">
                    <i class="fas fa-save"></i> Save to Flash
                </button>
                <button class="btn btn-secondary" onclick="loadWiFiConfig()" id="loadWiFiBtn">
                    <i class="fas fa-sync"></i> Reload
                </button>
            </div>
            <div class="progress-bar" id="wifiProgress">
                <div class="progress-fill"></div>
            </div>
        </div>

        <!-- GNSS Configuration Tab -->
        <div class="content-section" id="gnss-tab">
            <div class="section-header">
                <i class="fas fa-satellite"></i>
                <h2>GNSS Configuration</h2>
            </div>

            <div class="alert alert-success" id="gnss-alert-success"></div>
            <div class="alert alert-error" id="gnss-alert-error"></div>

            <div id="gnss-unavailable" style="display: none;">
                <div class="info-card">
                    <p><strong><i class="fas fa-info-circle"></i> GNSS Not Available</strong></p>
                    <p>This board does not have a built-in GNSS port. For V3 boards, you can connect an external GNSS module and configure the pins below.</p>
                </div>
            </div>

            <div class="form-grid">
                <div class="checkbox-group" style="grid-column: span 2;">
                    <input type="checkbox" id="gnssEnabled">
                    <label for="gnssEnabled">Enable GNSS Module</label>
                </div>

                <div class="checkbox-group" style="grid-column: span 2;">
                    <input type="checkbox" id="gnssSerialPassthrough">
                    <label for="gnssSerialPassthrough">Serial Passthrough</label>
                    <div class="help-text" style="margin-left: 32px;">Forward NMEA sentences to USB serial port</div>
                </div>

                <div class="form-group">
                    <label for="gnssTcpPort"><i class="fas fa-server"></i> NMEA TCP Port</label>
                    <input type="number" id="gnssTcpPort" min="1" max="65535" value="10110">
                    <div class="help-text">Standard NMEA-over-TCP port: 10110</div>
                </div>

                <div class="form-group">
                    <label for="gnssBaudRate"><i class="fas fa-tachometer-alt"></i> Baud Rate</label>
                    <select id="gnssBaudRate">
                        <option value="4800">4800</option>
                        <option value="9600">9600</option>
                        <option value="19200">19200</option>
                        <option value="38400">38400</option>
                        <option value="57600">57600</option>
                        <option value="115200">115200</option>
                    </select>
                    <div class="help-text">Most GNSS modules use 9600</div>
                </div>
            </div>

            <div id="gnss-pin-config" style="display: none;">
                <h3 style="color: var(--accent); margin: 32px 0 16px 0;"><i class="fas fa-cogs"></i> External Module Pin Configuration</h3>
                <p style="color: var(--text-secondary); margin-bottom: 16px;"><small>Configure GPIO pins for external GNSS module. Set to -1 to disable unused pins.</small></p>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="gnssPinRX"><i class="fas fa-arrow-left"></i> RX Pin (MCU ← GNSS)</label>
                        <input type="number" id="gnssPinRX" min="-1" max="48" value="-1">
                    </div>

                    <div class="form-group">
                        <label for="gnssPinTX"><i class="fas fa-arrow-right"></i> TX Pin (MCU → GNSS)</label>
                        <input type="number" id="gnssPinTX" min="-1" max="48" value="-1">
                    </div>

                    <div class="form-group">
                        <label for="gnssPinCtrl"><i class="fas fa-power-off"></i> Control Pin (Power)</label>
                        <input type="number" id="gnssPinCtrl" min="-1" max="48" value="-1">
                    </div>

                    <div class="form-group">
                        <label for="gnssPinWake"><i class="fas fa-bell"></i> Wake Pin</label>
                        <input type="number" id="gnssPinWake" min="-1" max="48" value="-1">
                    </div>

                    <div class="form-group">
                        <label for="gnssPinPPS"><i class="fas fa-clock"></i> PPS Pin (Pulse Per Second)</label>
                        <input type="number" id="gnssPinPPS" min="-1" max="48" value="-1">
                    </div>

                    <div class="form-group">
                        <label for="gnssPinRST"><i class="fas fa-redo"></i> Reset Pin</label>
                        <input type="number" id="gnssPinRST" min="-1" max="48" value="-1">
                    </div>
                </div>
            </div>

            <h3 style="color: var(--accent); margin: 32px 0 16px 0;"><i class="fas fa-map-marker-alt"></i> GNSS Status</h3>
            <div class="info-grid" id="gnss-status-grid">
                <div class="info-card">
                    <h4><i class="fas fa-crosshairs"></i> GPS Fix</h4>
                    <div class="info-item">
                        <span class="label">Status:</span>
                        <span class="value" id="gnss-fix-status">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Satellites:</span>
                        <span class="value" id="gnss-satellites">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">HDOP:</span>
                        <span class="value" id="gnss-hdop">-</span>
                    </div>
                </div>

                <div class="info-card">
                    <h4><i class="fas fa-globe"></i> Position</h4>
                    <div class="info-item">
                        <span class="label">Latitude:</span>
                        <span class="value" id="gnss-lat">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Longitude:</span>
                        <span class="value" id="gnss-lon">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Altitude:</span>
                        <span class="value" id="gnss-alt">-</span>
                    </div>
                </div>

                <div class="info-card">
                    <h4><i class="fas fa-network-wired"></i> NMEA Server</h4>
                    <div class="info-item">
                        <span class="label">Status:</span>
                        <span class="value" id="gnss-nmea-status">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Port:</span>
                        <span class="value" id="gnss-nmea-port">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Clients:</span>
                        <span class="value" id="gnss-nmea-clients">-</span>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="applyGNSSConfig()" id="applyGNSSBtn">
                    <i class="fas fa-play"></i> Apply Configuration
                </button>
                <button class="btn btn-primary" onclick="saveGNSSConfig()" id="saveGNSSBtn">
                    <i class="fas fa-save"></i> Save to Flash
                </button>
                <button class="btn btn-secondary" onclick="loadGNSSConfig()" id="loadGNSSBtn">
                    <i class="fas fa-sync"></i> Reload
                </button>
            </div>
            <div class="progress-bar" id="gnssProgress">
                <div class="progress-fill"></div>
            </div>
        </div>

        <!-- System Info Tab -->
        <div class="content-section" id="system-tab">
            <div class="section-header">
                <i class="fas fa-cogs"></i>
                <h2>System Information</h2>
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <h4><i class="fas fa-microchip"></i> Board Information</h4>
                    <div class="info-item">
                        <span class="label">Board Name:</span>
                        <span class="value" id="sys-board-name">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Board Type:</span>
                        <span class="value" id="sys-board-type">-</span>
                    </div>
                </div>

                <div class="info-card">
                    <h4><i class="fas fa-memory"></i> Chip Information</h4>
                    <div class="info-item">
                        <span class="label">Model:</span>
                        <span class="value" id="sys-chip-model">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Revision:</span>
                        <span class="value" id="sys-chip-revision">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Cores:</span>
                        <span class="value" id="sys-chip-cores">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Frequency:</span>
                        <span class="value" id="sys-chip-freq">-</span>
                    </div>
                </div>

                <div class="info-card">
                    <h4><i class="fas fa-hdd"></i> Memory Information</h4>
                    <div class="info-item">
                        <span class="label">Flash Size:</span>
                        <span class="value" id="sys-flash-size">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Free Heap:</span>
                        <span class="value" id="sys-free-heap">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Heap Size:</span>
                        <span class="value" id="sys-heap-size">-</span>
                    </div>
                </div>

                <div class="info-card">
                    <h4><i class="fas fa-broadcast-tower"></i> Current LoRa Config</h4>
                    <div class="info-item">
                        <span class="label">Frequency:</span>
                        <span class="value" id="sys-lora-freq">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Bandwidth:</span>
                        <span class="value" id="sys-lora-bw">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Spreading:</span>
                        <span class="value" id="sys-lora-sf">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Power:</span>
                        <span class="value" id="sys-lora-pwr">-</span>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="loadSystemInfo()" id="refreshSystemBtn">
                    <i class="fas fa-sync"></i> Refresh
                </button>
                <button class="btn btn-danger" onclick="rebootDevice()" id="rebootBtn">
                    <i class="fas fa-power-off"></i> Reboot Device
                </button>
            </div>
            <div class="progress-bar" id="systemProgress">
                <div class="progress-fill"></div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="floating-action-btn" onclick="toggleKeyboardShortcuts()" title="Keyboard Shortcuts">
        <i class="fas fa-keyboard"></i>
    </button>

    <!-- Keyboard Shortcuts Panel -->
    <div class="keyboard-shortcuts" id="keyboardShortcuts">
        <h4><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h4>
        <div class="shortcut">
            <span>Switch to LoRa tab</span>
            <span class="key">1</span>
        </div>
        <div class="shortcut">
            <span>Switch to Network tab</span>
            <span class="key">2</span>
        </div>
        <div class="shortcut">
            <span>Switch to GNSS tab</span>
            <span class="key">3</span>
        </div>
        <div class="shortcut">
            <span>Switch to System tab</span>
            <span class="key">4</span>
        </div>
        <div class="shortcut">
            <span>Refresh current tab</span>
            <span class="key">R</span>
        </div>
        <div class="shortcut">
            <span>Toggle auto-refresh</span>
            <span class="key">A</span>
        </div>
        <div class="shortcut">
            <span>Show/hide shortcuts</span>
            <span class="key">?</span>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div class="confirmation-dialog" id="confirmationDialog">
        <div class="confirmation-content">
            <h3 id="confirmationTitle">Confirm Action</h3>
            <p id="confirmationMessage">Are you sure you want to proceed?</p>
            <div class="confirmation-actions">
                <button class="btn btn-secondary" onclick="closeConfirmation()">Cancel</button>
                <button class="btn btn-danger" id="confirmationConfirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        let currentTab = 'lora';
        let autoRefreshEnabled = true;
        let autoRefreshInterval = null;
        let toastCounter = 0;

        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function() {
            tippy('.tooltip-trigger', {
                theme: 'light',
                placement: 'top',
                arrow: true,
                delay: [300, 0]
            });
        });

        // Switch between tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.closest('.nav-tab').classList.add('active');

            // Update tab content
            document.querySelectorAll('.content-section').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');

            currentTab = tabName;

            // Load data for the tab
            if (tabName === 'lora') {
                loadLoRaConfig();
            } else if (tabName === 'wifi') {
                loadWiFiConfig();
            } else if (tabName === 'gnss') {
                loadGNSSConfig();
                loadGNSSStatus();
            } else if (tabName === 'system') {
                loadSystemInfo();
            }
        }

        // Show alert message (now uses toast notifications)
        function showAlert(type, message, prefix = currentTab) {
            const title = type === 'success' ? 'Success' : type === 'error' ? 'Error' : 'Warning';
            showToast(type, title, message);
        }

        // Enhanced UX Functions
        function showToast(type, title, message, duration = 5000) {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + (++toastCounter);

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.id = toastId;
            toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-icon">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'exclamation-triangle'}"></i>
                    </div>
                    <div class="toast-text">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" onclick="hideToast('${toastId}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            toastContainer.appendChild(toast);

            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 10);

            // Auto-hide
            if (duration > 0) {
                setTimeout(() => hideToast(toastId), duration);
            }

            return toastId;
        }

        function hideToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }
        }

        function showConfirmation(title, message, confirmCallback, confirmText = 'Confirm', danger = false) {
            const dialog = document.getElementById('confirmationDialog');
            const titleEl = document.getElementById('confirmationTitle');
            const messageEl = document.getElementById('confirmationMessage');
            const confirmBtn = document.getElementById('confirmationConfirm');

            titleEl.textContent = title;
            messageEl.textContent = message;
            confirmBtn.textContent = confirmText;
            confirmBtn.className = `btn ${danger ? 'btn-danger' : 'btn-primary'}`;
            confirmBtn.onclick = () => {
                confirmCallback();
                closeConfirmation();
            };

            dialog.classList.add('show');
        }

        function closeConfirmation() {
            document.getElementById('confirmationDialog').classList.remove('show');
        }

        function setButtonLoading(buttonId, loading) {
            const button = document.getElementById(buttonId);
            if (button) {
                if (loading) {
                    button.classList.add('loading');
                    button.disabled = true;
                } else {
                    button.classList.remove('loading');
                    button.disabled = false;
                }
            }
        }

        function showProgress(progressId, show) {
            const progress = document.getElementById(progressId);
            if (progress) {
                if (show) {
                    progress.classList.add('show');
                    const fill = progress.querySelector('.progress-fill');
                    fill.style.width = '0%';
                    setTimeout(() => fill.style.width = '100%', 10);
                } else {
                    progress.classList.remove('show');
                }
            }
        }

        function validateField(fieldId, validator, errorMessage) {
            const field = document.getElementById(fieldId);
            const group = field.closest('.form-group');
            const validationEl = document.getElementById(fieldId + '-validation');

            if (validator(field.value)) {
                group.classList.remove('error');
                group.classList.add('success');
                if (validationEl) validationEl.textContent = '';
                return true;
            } else {
                group.classList.remove('success');
                group.classList.add('error');
                if (validationEl) validationEl.textContent = errorMessage;
                return false;
            }
        }

        function clearValidation(fieldId) {
            const field = document.getElementById(fieldId);
            const group = field.closest('.form-group');
            const validationEl = document.getElementById(fieldId + '-validation');

            group.classList.remove('error', 'success');
            if (validationEl) validationEl.textContent = '';
        }

        function toggleAutoRefresh() {
            autoRefreshEnabled = document.getElementById('autoRefresh').checked;
            if (autoRefreshEnabled) {
                startAutoRefresh();
                showToast('success', 'Auto-refresh Enabled', 'Status will update automatically every 5 seconds');
            } else {
                stopAutoRefresh();
                showToast('warning', 'Auto-refresh Disabled', 'Status will not update automatically');
            }
        }

        function startAutoRefresh() {
            stopAutoRefresh(); // Clear any existing interval
            autoRefreshInterval = setInterval(() => {
                if (autoRefreshEnabled) {
                    loadStatus();
                }
            }, 5000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        function toggleKeyboardShortcuts() {
            const shortcuts = document.getElementById('keyboardShortcuts');
            shortcuts.classList.toggle('show');
        }

        function filterNetworks() {
            const searchTerm = document.getElementById('networkSearch').value.toLowerCase();
            const networks = document.querySelectorAll('.network-item');

            networks.forEach(network => {
                const ssid = network.textContent.toLowerCase();
                if (ssid.includes(searchTerm)) {
                    network.style.display = 'flex';
                } else {
                    network.style.display = 'none';
                }
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ignore if user is typing in an input field
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }

            switch(e.key.toLowerCase()) {
                case '1':
                    e.preventDefault();
                    switchTab('lora');
                    break;
                case '2':
                    e.preventDefault();
                    switchTab('wifi');
                    break;
                case '3':
                    e.preventDefault();
                    switchTab('gnss');
                    break;
                case '4':
                    e.preventDefault();
                    switchTab('system');
                    break;
                case 'r':
                    e.preventDefault();
                    refreshCurrentTab();
                    break;
                case 'a':
                    e.preventDefault();
                    const autoRefresh = document.getElementById('autoRefresh');
                    autoRefresh.checked = !autoRefresh.checked;
                    toggleAutoRefresh();
                    break;
                case '?':
                    e.preventDefault();
                    toggleKeyboardShortcuts();
                    break;
            }
        });

        function refreshCurrentTab() {
            switch(currentTab) {
                case 'lora':
                    loadLoRaConfig();
                    break;
                case 'wifi':
                    loadWiFiConfig();
                    break;
                case 'gnss':
                    loadGNSSConfig();
                    loadGNSSStatus();
                    break;
                case 'system':
                    loadSystemInfo();
                    break;
            }
            showToast('success', 'Refreshed', `Reloaded ${currentTab} configuration`);
        }        // Load status
        async function loadStatus() {
            try {
                const data = await apiGet('status');

                // Update WiFi status - handle AP+STA mode
                if (data.wifi.connected && data.wifi.ap_active) {
                    document.getElementById('wifiStatus').textContent = 'AP + Station';
                    document.getElementById('wifiIcon').className = 'status-icon online';
                    document.getElementById('ipAddress').textContent = 'AP: ' + data.wifi.ap_ip + ' | STA: ' + data.wifi.sta_ip;
                } else if (data.wifi.connected) {
                    document.getElementById('wifiStatus').textContent = 'Connected';
                    document.getElementById('wifiIcon').className = 'status-icon online';
                    document.getElementById('ipAddress').textContent = data.wifi.sta_ip;
                } else if (data.wifi.ap_active) {
                    document.getElementById('wifiStatus').textContent = 'AP Mode';
                    document.getElementById('wifiIcon').className = 'status-icon online';
                    document.getElementById('ipAddress').textContent = data.wifi.ap_ip;
                } else {
                    document.getElementById('wifiStatus').textContent = 'Offline';
                    document.getElementById('wifiIcon').className = 'status-icon offline';
                    document.getElementById('ipAddress').textContent = '-';
                }

                // Update battery
                document.getElementById('battery').textContent = data.battery.voltage.toFixed(2) + ' V';

                // Update uptime
                const uptime = data.system.uptime;
                const hours = Math.floor(uptime / 3600);
                const minutes = Math.floor((uptime % 3600) / 60);
                document.getElementById('uptime').textContent = hours + 'h ' + minutes + 'm';

            } catch (error) {
                console.error('Failed to load status:', error);
            }
        }

        // LoRa Configuration
        async function loadLoRaConfig() {
            try {
                const data = await apiGet('lora/config');
                document.getElementById('frequency').value = data.frequency;
                document.getElementById('bandwidth').value = data.bandwidth;
                document.getElementById('spreading').value = data.spreading;
                document.getElementById('codingRate').value = data.codingRate;
                document.getElementById('power').value = data.power;
                document.getElementById('syncWord').value = '0x' + data.syncWord.toString(16).toUpperCase();
            } catch (error) {
                showAlert('error', 'Failed to load LoRa configuration');
            }
        }

        async function applyLoRaConfig() {
            // Validate inputs
            const frequencyValid = validateField('frequency', (val) => {
                const num = parseFloat(val);
                return num >= 150 && num <= 960;
            }, 'Frequency must be between 150-960 MHz');

            const powerValid = validateField('power', (val) => {
                const num = parseInt(val);
                return num >= -9 && num <= 22;
            }, 'Power must be between -9 to 22 dBm');

            const syncWordValid = validateField('syncWord', (val) => {
                return /^0x[0-9A-Fa-f]{4}$/.test(val);
            }, 'Sync word must be in format 0xXXXX (4 hex digits)');

            if (!frequencyValid || !powerValid || !syncWordValid) {
                showToast('error', 'Validation Error', 'Please correct the highlighted fields');
                return;
            }

            setButtonLoading('applyLoRaBtn', true);
            showProgress('loraProgress', true);

            try {
                const syncWord = parseInt(document.getElementById('syncWord').value, 16);

                const config = {
                    frequency: parseFloat(document.getElementById('frequency').value),
                    bandwidth: parseFloat(document.getElementById('bandwidth').value),
                    spreading: parseInt(document.getElementById('spreading').value),
                    codingRate: parseInt(document.getElementById('codingRate').value),
                    power: parseInt(document.getElementById('power').value),
                    syncWord: syncWord
                };

                await apiPost('lora/config', config);
                showAlert('success', 'LoRa configuration applied successfully');
            } catch (error) {
                showAlert('error', 'Failed to apply LoRa configuration');
            } finally {
                setButtonLoading('applyLoRaBtn', false);
                setTimeout(() => showProgress('loraProgress', false), 1000);
            }
        }        async function saveLoRaConfig() {
            setButtonLoading('saveLoRaBtn', true);
            showProgress('loraProgress', true);

            try {
                await apiPost('lora/save');
                showAlert('success', 'LoRa configuration saved to flash');
            } catch (error) {
                showAlert('error', 'Failed to save LoRa configuration');
            } finally {
                setButtonLoading('saveLoRaBtn', false);
                setTimeout(() => showProgress('loraProgress', false), 1000);
            }
        }

        async function resetLoRaConfig() {
            showConfirmation(
                'Reset LoRa Configuration',
                'Are you sure you want to reset LoRa configuration to defaults? This will restore factory settings.',
                async () => {
                    setButtonLoading('resetLoRaBtn', true);
                    showProgress('loraProgress', true);

                    try {
                        await apiPost('lora/reset');
                        showAlert('success', 'LoRa configuration reset to defaults');
                        await loadLoRaConfig();
                        // Clear validation states
                        clearValidation('frequency');
                        clearValidation('power');
                        clearValidation('syncWord');
                    } catch (error) {
                        showAlert('error', 'Failed to reset LoRa configuration');
                    } finally {
                        setButtonLoading('resetLoRaBtn', false);
                        setTimeout(() => showProgress('loraProgress', false), 1000);
                    }
                },
                'Reset',
                true
            );
        }

        // WiFi Configuration
        async function loadWiFiConfig() {
            try {
                const data = await apiGet('wifi/config');
                document.getElementById('wifiMode').value = data.mode;
                document.getElementById('apSsid').value = data.ap_ssid;
                document.getElementById('staSsid').value = data.ssid;
                document.getElementById('dhcp').checked = data.dhcp;
                document.getElementById('staticIp').value = data.ip;
                document.getElementById('gateway').value = data.gateway;
                document.getElementById('subnet').value = data.subnet;
                document.getElementById('dns').value = data.dns;
                document.getElementById('tcpKissEnabled').checked = data.tcp_kiss_enabled;
                document.getElementById('tcpKissPort').value = data.tcp_kiss_port;

                updateWiFiModeUI();
                updateDHCPUI();
            } catch (error) {
                showAlert('error', 'Failed to load WiFi configuration', 'wifi');
            }
        }

        function updateWiFiModeUI() {
            const mode = parseInt(document.getElementById('wifiMode').value);
            const apConfig = document.getElementById('ap-config');
            const staConfig = document.getElementById('sta-config');

            apConfig.style.display = (mode === 1 || mode === 3) ? 'block' : 'none';
            staConfig.style.display = (mode === 2 || mode === 3) ? 'block' : 'none';
        }

        function updateDHCPUI() {
            const dhcp = document.getElementById('dhcp').checked;
            document.getElementById('static-ip-config').style.display = dhcp ? 'none' : 'block';
        }

        async function applyWiFiConfig() {
            setButtonLoading('applyWiFiBtn', true);
            showProgress('wifiProgress', true);

            try {
                const config = {
                    mode: parseInt(document.getElementById('wifiMode').value),
                    ap_ssid: document.getElementById('apSsid').value,
                    ap_password: document.getElementById('apPassword').value,
                    ssid: document.getElementById('staSsid').value,
                    password: document.getElementById('staPassword').value,
                    dhcp: document.getElementById('dhcp').checked,
                    tcp_kiss_enabled: document.getElementById('tcpKissEnabled').checked,
                    tcp_kiss_port: parseInt(document.getElementById('tcpKissPort').value)
                };

                const currentMode = parseInt(document.getElementById('wifiMode').value);

                await apiPost('wifi/config', config);

                // If changing WiFi mode, warn user about connection loss
                if (currentMode === 0 || currentMode === 2) {
                    showAlert('success', 'WiFi configuration applied. Note: Connection may be lost if changing modes. You may need to reconnect to the new network.', 'wifi');
                } else {
                    showAlert('success', 'WiFi configuration applied successfully', 'wifi');
                }
            } catch (error) {
                showAlert('error', 'Failed to apply WiFi configuration', 'wifi');
            } finally {
                setButtonLoading('applyWiFiBtn', false);
                setTimeout(() => showProgress('wifiProgress', false), 1000);
            }
        }        async function saveWiFiConfig() {
            try {
                await apiPost('wifi/save');
                showAlert('success', 'WiFi configuration saved to flash', 'wifi');
            } catch (error) {
                showAlert('error', 'Failed to save WiFi configuration', 'wifi');
            }
        }

        async function scanWiFi() {
            try {
                document.getElementById('networkListContent').innerHTML = '<div class="loading">Scanning networks...</div>';
                document.getElementById('networkList').style.display = 'block';
                document.getElementById('networkSearch').value = ''; // Clear search

                const data = await apiGet('wifi/scan');
                const listContent = document.getElementById('networkListContent');
                listContent.innerHTML = '';

                if (data.networks && data.networks.length > 0) {
                    data.networks.forEach(network => {
                        const item = document.createElement('div');
                        item.className = 'network-item';
                        item.onclick = () => {
                            document.getElementById('staSsid').value = network.ssid;
                            showToast('success', 'Network Selected', `Selected: ${network.ssid}`);
                        };

                        let signalIcon = '📶';
                        if (network.rssi > -50) signalIcon = '📶📶📶';
                        else if (network.rssi > -70) signalIcon = '📶📶';

                        item.innerHTML = `
                            <div class="network-info">
                                <div class="signal-strength">${signalIcon}</div>
                                <div class="network-details">
                                    <strong>${network.ssid}</strong><br>
                                    <small>${network.rssi} dBm ${network.encrypted ? '🔒' : '🔓'}</small>
                                </div>
                            </div>
                        `;

                        listContent.appendChild(item);
                    });
                    showToast('success', 'Scan Complete', `Found ${data.networks.length} networks`);
                } else {
                    listContent.innerHTML = '<div class="loading">No networks found</div>';
                    showToast('warning', 'No Networks', 'No WiFi networks were found');
                }
            } catch (error) {
                showAlert('error', 'Failed to scan WiFi networks', 'wifi');
            }
        }

        // GNSS Configuration
        async function loadGNSSConfig() {
            try {
                const data = await apiGet('gnss/config');
                document.getElementById('gnssEnabled').checked = data.enabled;
                document.getElementById('gnssSerialPassthrough').checked = data.serialPassthrough || false;
                document.getElementById('gnssTcpPort').value = data.tcpPort;
                document.getElementById('gnssBaudRate').value = data.baudRate;

                // Show/hide pin configuration based on board type
                if (data.hasBuiltInPort) {
                    document.getElementById('gnss-pin-config').style.display = 'none';
                    document.getElementById('gnss-unavailable').style.display = 'none';
                } else {
                    document.getElementById('gnss-pin-config').style.display = 'block';
                    document.getElementById('gnss-unavailable').style.display = 'block';

                    // Load pin configuration
                    document.getElementById('gnssPinRX').value = data.pinRX;
                    document.getElementById('gnssPinTX').value = data.pinTX;
                    document.getElementById('gnssPinCtrl').value = data.pinCtrl;
                    document.getElementById('gnssPinWake').value = data.pinWake;
                    document.getElementById('gnssPinPPS').value = data.pinPPS;
                    document.getElementById('gnssPinRST').value = data.pinRST;
                }
            } catch (error) {
                showAlert('error', 'Failed to load GNSS configuration', 'gnss');
            }
        }

        async function loadGNSSStatus() {
            try {
                const data = await apiGet('gnss/status');

                if (data.running) {
                    document.getElementById('gnss-fix-status').textContent = data.hasFix ? '✅ Fixed' : '⏳ Searching';
                    document.getElementById('gnss-satellites').textContent = data.satellites || 0;
                    document.getElementById('gnss-hdop').textContent = data.hdop ? data.hdop.toFixed(1) : '-';

                    if (data.hasFix) {
                        document.getElementById('gnss-lat').textContent = data.latitude ? data.latitude.toFixed(6) + '°' : '-';
                        document.getElementById('gnss-lon').textContent = data.longitude ? data.longitude.toFixed(6) + '°' : '-';
                        document.getElementById('gnss-alt').textContent = data.altitude ? data.altitude.toFixed(1) + ' m' : '-';
                    } else {
                        document.getElementById('gnss-lat').textContent = '-';
                        document.getElementById('gnss-lon').textContent = '-';
                        document.getElementById('gnss-alt').textContent = '-';
                    }
                } else {
                    document.getElementById('gnss-fix-status').textContent = '⭕ Disabled';
                    document.getElementById('gnss-satellites').textContent = '-';
                    document.getElementById('gnss-hdop').textContent = '-';
                    document.getElementById('gnss-lat').textContent = '-';
                    document.getElementById('gnss-lon').textContent = '-';
                    document.getElementById('gnss-alt').textContent = '-';
                }

                if (data.nmeaServer) {
                    document.getElementById('gnss-nmea-status').textContent = data.nmeaServer.running ? '✅ Running' : '⭕ Stopped';
                    document.getElementById('gnss-nmea-port').textContent = data.nmeaServer.port;
                    document.getElementById('gnss-nmea-clients').textContent = data.nmeaServer.clients;
                } else {
                    document.getElementById('gnss-nmea-status').textContent = '-';
                    document.getElementById('gnss-nmea-port').textContent = '-';
                    document.getElementById('gnss-nmea-clients').textContent = '-';
                }
            } catch (error) {
                console.error('Failed to load GNSS status:', error);
            }
        }

        async function applyGNSSConfig() {
            try {
                const config = {
                    enabled: document.getElementById('gnssEnabled').checked,
                    serialPassthrough: document.getElementById('gnssSerialPassthrough').checked,
                    tcpPort: parseInt(document.getElementById('gnssTcpPort').value),
                    baudRate: parseInt(document.getElementById('gnssBaudRate').value)
                };

                // Add pin config if visible (V3 boards)
                if (document.getElementById('gnss-pin-config').style.display !== 'none') {
                    config.pinRX = parseInt(document.getElementById('gnssPinRX').value);
                    config.pinTX = parseInt(document.getElementById('gnssPinTX').value);
                    config.pinCtrl = parseInt(document.getElementById('gnssPinCtrl').value);
                    config.pinWake = parseInt(document.getElementById('gnssPinWake').value);
                    config.pinPPS = parseInt(document.getElementById('gnssPinPPS').value);
                    config.pinRST = parseInt(document.getElementById('gnssPinRST').value);
                }

                const result = await apiPost('gnss/config', config);

                if (result.rebootRequired) {
                    showAlert('success', 'GNSS configuration applied. Reboot required for TCP port or baud rate changes.', 'gnss');
                } else {
                    showAlert('success', 'GNSS configuration applied successfully', 'gnss');
                }

                // Reload status after a moment
                setTimeout(loadGNSSStatus, 1000);
            } catch (error) {
                showAlert('error', 'Failed to apply GNSS configuration', 'gnss');
            }
        }

        async function saveGNSSConfig() {
            // Apply first, which saves to NVS
            await applyGNSSConfig();
        }

        // System Information
        async function loadSystemInfo() {
            try {
                const sysData = await apiGet('system');
                const loraData = await apiGet('lora/config');

                // Board info
                document.getElementById('sys-board-name').textContent = sysData.board.name;
                document.getElementById('sys-board-type').textContent = 'V' + sysData.board.type;

                // Chip info
                document.getElementById('sys-chip-model').textContent = sysData.chip.model;
                document.getElementById('sys-chip-revision').textContent = sysData.chip.revision;
                document.getElementById('sys-chip-cores').textContent = sysData.chip.cores;
                document.getElementById('sys-chip-freq').textContent = sysData.chip.frequency + ' MHz';

                // Memory info
                document.getElementById('sys-flash-size').textContent = (sysData.memory.flash_size / 1024 / 1024).toFixed(0) + ' MB';
                document.getElementById('sys-free-heap').textContent = (sysData.memory.free_heap / 1024).toFixed(1) + ' KB';
                document.getElementById('sys-heap-size').textContent = (sysData.memory.heap_size / 1024).toFixed(1) + ' KB';

                // LoRa config
                document.getElementById('sys-lora-freq').textContent = loraData.frequency + ' MHz';
                document.getElementById('sys-lora-bw').textContent = loraData.bandwidth + ' kHz';
                document.getElementById('sys-lora-sf').textContent = 'SF' + loraData.spreading;
                document.getElementById('sys-lora-pwr').textContent = loraData.power + ' dBm';

            } catch (error) {
                console.error('Failed to load system info:', error);
            }
        }

        async function rebootDevice() {
            showConfirmation(
                'Reboot Device',
                'Are you sure you want to reboot the device? This will temporarily disconnect all connections.',
                async () => {
                    setButtonLoading('rebootBtn', true);
                    showProgress('systemProgress', true);

                    try {
                        await apiPost('reboot');
                        showToast('warning', 'Rebooting', 'Device is rebooting. Please wait 10 seconds and refresh the page.', 0);
                    } catch (error) {
                        showAlert('error', 'Failed to reboot device');
                        setButtonLoading('rebootBtn', false);
                        showProgress('systemProgress', false);
                    }
                },
                'Reboot',
                true
            );
        }

        // Initialize
        async function init() {
            // Show loading screen
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('hidden');

            // Load initial data in parallel for faster loading
            const [statusResult, sysData, loraConfigResult] = await Promise.all([
                loadStatus(),
                apiGet('system'),
                loadLoRaConfig()
            ]);

            // Update board name from system data
            document.getElementById('boardName').textContent = sysData.board.name;

            // Start auto-refresh
            startAutoRefresh();

            // Update status every 5 seconds
            setInterval(() => {
                if (autoRefreshEnabled) {
                    loadStatus();
                }
            }, 5000);

            // Update GNSS status every 3 seconds if on GNSS tab
            setInterval(() => {
                if (currentTab === 'gnss') {
                    loadGNSSStatus();
                }
            }, 3000);

            // Show welcome message and hide loading screen
            setTimeout(() => {
                loadingOverlay.classList.add('hidden');
                showToast('success', 'Welcome', 'LoRaTNCX Control Center loaded successfully');
            }, 1000);
        }

        // API Helper Functions
        async function apiGet(endpoint) {
            const response = await fetch(`/api/${endpoint}`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return await response.json();
        }

        async function apiPost(endpoint, data = null) {
            const config = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            };
            
            if (data !== null) {
                config.body = JSON.stringify(data);
            }
            
            const response = await fetch(`/api/${endpoint}`, config);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            // Some endpoints return JSON, others just success messages
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return await response.json();
            } else {
                return { success: true };
            }
        }

        // Start when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
